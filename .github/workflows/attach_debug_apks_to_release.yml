name: Build Debug APKs To Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package_variant: [apt-android-7]

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Make Gradle Wrapper executable
        run: chmod +x ./gradlew

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Read VERSION_NAME from gradle.properties
        id: version
        shell: bash
        run: |
          VERSION_NAME=$(./gradlew -q properties | grep "^VERSION_NAME:" | awk '{print $2}')

          if [ -z "$VERSION_NAME" ]; then
            echo "::error::VERSION_NAME not found!"
            exit 1
          fi

          RELEASE_VERSION_NAME="v${VERSION_NAME}+${GITHUB_SHA:0:7}"
          APK_VERSION_TAG="${RELEASE_VERSION_NAME}+${{ matrix.package_variant }}-github-debug"

          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "RELEASE_VERSION_NAME=$RELEASE_VERSION_NAME" >> $GITHUB_ENV
          echo "APK_VERSION_TAG=$APK_VERSION_TAG" >> $GITHUB_ENV

          echo "Version       : $VERSION_NAME"
          echo "Release Tag   : $RELEASE_VERSION_NAME"
          echo "APK Tag       : $APK_VERSION_TAG"

      - name: Build Debug APK
        run: |
          echo "Building APKs for $APK_VERSION_TAG"
          ./gradlew assembleDebug

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ matrix.package_variant }}
          path: app/build/outputs/apk/debug/*.apk

  upload:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read VERSION_NAME again
        id: get_version
        run: |
          VERSION_NAME=$(./gradlew -q properties | grep "^VERSION_NAME:" | awk '{print $2}')
          RELEASE_VERSION_NAME="v${VERSION_NAME}+${GITHUB_SHA:0:7}"
          echo "release_version=$RELEASE_VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify APKs
        run: |
          find artifacts -type f -name '*.apk' -print

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.release_version }}
          name: Release ${{ steps.get_version.outputs.release_version }}
          files: artifacts/**/*.apk
          generate_release_notes: true
          prerelease: true
          fail_on_unmatched_files: false